pipeline {
    agent any

    environment {
        AWS_CREDENTIALS_ID = 'aws-creds'
        CLUSTER_NAME = 'app-clus'
        REGION = 'us-west-2'
    }

    stages {
        stage('Create EKS Cluster (If Not Exists)') {
            steps {
                script {
                    catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
                        withAWS(credentials: "${AWS_CREDENTIALS_ID}", region: "${REGION}") {
                            echo "üîç Checking if EKS cluster '${CLUSTER_NAME}' already exists..."
                            def clusterStatus = sh(
                                script: """
                                    aws eks describe-cluster \
                                        --name ${CLUSTER_NAME} \
                                        --region ${REGION} \
                                        --query 'cluster.status' \
                                        --output text || echo "NOTFOUND"
                                """,
                                returnStdout: true
                            ).trim()

                            if (clusterStatus == "ACTIVE" || clusterStatus == "CREATING") {
                                echo "‚úÖ Cluster '${CLUSTER_NAME}' already exists with status: ${clusterStatus}"
                            } else {
                                echo "üöÄ Cluster not found. Creating new EKS cluster..."
                                sh """
                                    set -e
                                    eksctl create cluster \
                                        --name ${CLUSTER_NAME} \
                                        --version 1.30 \
                                        --region ${REGION} \
                                        --nodegroup-name stand-work \
                                        --node-type t3.medium \
                                        --nodes 2 \
                                        --nodes-min 2 \
                                        --nodes-max 3 \
                                        --managed
                                """
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        success {
            echo '‚úÖ EKS cluster creation job completed (or already existed).'
        }
        failure {
            echo '‚ùå EKS cluster creation job failed.'
        }
    }
}
